@model BlogCommentViewModel
@{
    ViewData["Title"] = "Details";
    var userOfBlog = Model.Blog.User;
    var recentBlogs = Model.BlogsAtDate;
}

<!-- Page Title -->
<div class="page-title light-background">
    <div class="container">
        <h1>Blog Details</h1>
        <nav class="breadcrumbs">
            <ol>
                <li><a asp-action="Index" asp-controller="Home">Home</a></li>
                <li class="current">Blog Details</li>
            </ol>
        </nav>
    </div>
</div><!-- End Page Title -->

<div class="container">
    <div class="row">
        <div class="col-lg-8">
            <!-- Blog Details Section -->
            <section id="blog-details" class="blog-details section">
                <div class="container">
                    <article class="article">
                        <div class="post-img">
                            <img src="@Model.Blog.Image" alt="" class="img-fluid w-100">
                        </div>

                        <h2 class="title">@Model.Blog.Title</h2>
                        <h3 class="title">@Model.Blog.Category</h3>

                        <div class="meta-top">
                            <ul>
                                <li class="d-flex align-items-center">
                                    <i class="bi bi-person"></i>
                                    <a>@userOfBlog.FName @userOfBlog.LName</a>
                                </li>
                                <li class="d-flex align-items-center">
                                    <i class="bi bi-clock"></i>
                                    <a>
                                        <time datetime="@Model.Blog.CreatedDate.ToString()">
                                            @Model.Blog.CreatedDate.ToString("MMMM dd, yyyy")
                                        </time>
                                    </a>
                                </li>
                                <li class="d-flex align-items-center">
                                    <i class="bi bi-chat-dots"></i>
                                    <a href="#blog-comments">@Model.Blog.Comments.Count Comments</a>
                                </li>
                            </ul>
                        </div><!-- End meta top -->

                        <div class="content">
                            @Html.Raw(Model.Blog.BlogContent)
                        </div><!-- End post content -->

                        <div class="meta-bottom">
                            <i class="bi bi-folder"></i>
                            <ul class="cats">
                                <li><a href="#">@Model.Blog.Category</a></li>
                            </ul>

                            <i class="bi bi-tags"></i>
                            <ul class="tags">
                                <li><a href="#">Creative</a></li>
                                <li><a href="#">Tips</a></li>
                                <li><a href="#">Marketing</a></li>
                            </ul>
                        </div><!-- End meta bottom -->
                    </article>
                </div>
            </section><!-- /Blog Details Section -->
            <!-- Blog Comments Section -->
            <section id="blog-comments" class="blog-comments section">
                <div class="container">
                    @if (Model.Blog.Comments is not null && Model.Blog.Comments.Count > 0)
                    {
                        <h4 class="comments-count">@Model.Blog.Comments.Count Comments</h4>

                        <!-- Loop through each comment -->
                        @foreach (var comment in Model.Blog.Comments)
                        {
                            var userOfComment = comment.User;
                            var activeUser = Model.ActiveUser;

                            <div class="comment-box mb-3">
                                <div class="d-flex align-items-start">
                                    <!-- Commenter's Profile Image and Content -->
                                    <div class="comment-img">
                                        <img src="@userOfComment.Image" alt="User Image" class="rounded-circle">
                                    </div>
                                    <div class="comment-content ms-3">
                                        <h5>@userOfComment.FName @userOfComment.LName</h5>
                                        <time datetime="@comment.CreatedDateTime">
                                            @comment.CreatedDateTime.ToString("MMMM dd, yyyy")
                                        </time>
                                        <p>@comment.CommentContent</p>
                                    </div>

                                    <!-- Three-dot Menu for Actions -->
                                    @if (comment.UserId == activeUser.Id)
                                    {
                                        <div class="dropdown-container ms-3">
                                            <button class="btn p-0 dropdown-trigger" type="button"
                                                    onclick="toggleDropdown('commentActionsDropdown_@comment.Id')"
                                                    aria-expanded="false"
                                                    aria-controls="commentActionsDropdown_@comment.Id">
                                                <i class="bi bi-three-dots-vertical"></i>
                                            </button>

                                            <ul id="commentActionsDropdown_@comment.Id"
                                                class="dropdown-content dropdown-menu-end"
                                                aria-labelledby="commentActionsDropdown_@comment.Id"
                                                style="display: none;">
                                                <li>
                                                    <form asp-action="EditComment"
                                                          asp-route-commentId="@comment.Id"
                                                          asp-controller="Comment"
                                                          method="post">
                                                        <button type="submit" class="dropdown-item">
                                                            <i class="bi bi-pencil"></i> Edit
                                                        </button>
                                                    </form>
                                                </li>

                                                <li>
                                                    <form asp-action="DeleteComment"
                                                          asp-controller="Comment"
                                                          asp-route-commentId="@comment.Id"
                                                          method="post">
                                                        <button type="submit" class="dropdown-item">
                                                            <i class="bi bi-trash text-danger"></i> Delete
                                                        </button>
                                                    </form>
                                                </li>
                                            </ul>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <h4 class="comments-count">0 Comments</h4>
                    }
                </div>
            </section><!-- /Blog Comments Section -->
            <!-- Comment Form Section -->
            <section id="comment-form" class="comment-form section">
                <div class="container">
                    <form asp-action="AddComment" asp-controller="Comment" method="post">
                        <h4>Post Comment</h4>

                        <!-- Display validation errors -->
                        <div asp-validation-summary="All" class="text-danger mt-3"></div>

                        <div class="row">
                            <div class="col form-group">
                                <textarea asp-for="Comment.CommentContent"
                                          class="form-control"
                                          placeholder="Your Comment*"></textarea>
                                <span asp-validation-for="Comment.CommentContent" class="text-danger"></span>

                                <!-- Hidden input for Blog ID -->
                                <input type="hidden" asp-for="Comment.BlogId" value="@Model.Blog.Id" />
                            </div>
                        </div>

                        <div class="text-center">
                            <button type="submit" class="btn btn-primary">Post Comment</button>
                        </div>
                    </form>
                </div>
            </section><!-- /Comment Form Section -->
        </div>

        <div class="col-lg-4 sidebar">
            <div class="widgets-container">
                <!-- Blog Author Widget -->
                <div class="blog-author-widget widget-item">
                    <div class="d-flex flex-column align-items-center">
                        <img src="@userOfBlog.Image" class="rounded-circle flex-shrink-0" alt="">
                        <h4>@userOfBlog.FName @userOfBlog.LName</h4>
                        <p>
                            At @Model.Blog.Title, we aim to provide insights, tips, and discussions on a variety of topics to help you stay informed, inspired, and engaged. Whether you're here to learn something new, explore a fresh perspective, or dive deep into a subject, we have something for everyone. Our goal is to bring you content that is both relevant and thought-provoking, creating a space for discovery and growth.
                        </p>
                    </div>
                </div><!-- /Blog Author Widget -->
                <!-- Recent Posts Widget -->
                <div class="recent-posts-widget widget-item">
                    <h3 class="widget-title">Recent Posts</h3>
                    @foreach (var blog in recentBlogs)
                    {
                        if (blog.Id != Model.Blog.Id)
                        {
                            <div class="post-item">
                                <h4><a asp-action="Details" asp-route-id="@blog.Id">@blog.Title</a></h4>
                                <time datetime="@blog.CreatedDate">
                                    @blog.CreatedDate.ToString("MMMM dd, yyyy")
                                </time>
                            </div>
                        }
                    }
                </div><!-- End Recent Posts Widget -->
            </div><!-- /Widgets Container -->
        </div>
    </div>
</div>

<!-- Custom Dropdown Styles -->
<style>
    /* Dropdown container */
    .dropdown-container {
        position: relative;
        display: inline-block;
    }

    /* Dropdown content */
    .dropdown-content {
        position: absolute;
        background-color: white;
        min-width: 160px;
        box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
        z-index: 1000;
        border-radius: 0.375rem;
        padding: 0.5rem 0;
        margin-top: 0.25rem;
        border: 1px solid rgba(0,0,0,.15);
        list-style: none;
        margin: 0;
    }

    .dropdown-menu-end {
        right: 0;
        left: auto;
    }

    /* Dropdown items */
    .dropdown-item {
        display: block;
        width: 100%;
        padding: 0.375rem 1rem;
        clear: both;
        font-weight: 400;
        color: #212529;
        text-align: inherit;
        text-decoration: none;
        white-space: nowrap;
        background-color: transparent;
        border: 0;
        cursor: pointer;
        transition: background-color 0.15s ease-in-out;
    }

        .dropdown-item:hover {
            background-color: #f8f9fa;
        }

    .dropdown-content li {
        margin: 0;
    }

    /* Show dropdown when active class is added */
    .dropdown-content.show {
        display: block !important;
    }
</style>

<!-- Custom Dropdown Script -->
<script>
    // Simple JavaScript to toggle dropdown
    function toggleDropdown(dropdownId) {
        const dropdown = document.getElementById(dropdownId);
        const isVisible = dropdown.style.display === 'block';

        // Close all other dropdowns first
        document.querySelectorAll('.dropdown-content').forEach(el => {
            el.style.display = 'none';
            el.classList.remove('show');
        });

        // Toggle current dropdown
        if (!isVisible) {
            dropdown.style.display = 'block';
            dropdown.classList.add('show');
        }
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', function(event) {
        if (!event.target.closest('.dropdown-container')) {
            document.querySelectorAll('.dropdown-content').forEach(el => {
                el.style.display = 'none';
                el.classList.remove('show');
            });
        }
    });
</script>

<!-- External Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
}